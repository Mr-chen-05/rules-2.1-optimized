# 🔧 规则系统修复方案 v1.0

**生成时间**: 2025-10-18  
**修复优先级**: P0 (立即修复) → P1 (本周) → P2 (本月)  
**预计总工时**: 8-12 小时

---

## 🔴 P0 级别修复（立即处理）

### 1. 优先级冲突修复 ⚠️ **最高优先**

**问题**: 用户指令优先级与安全规则冲突

**影响文件**:
- `.rules/P0-core-safety/file-generation-safety-rules.mdc`
- `.rules/P0-core-safety/rule-conflict-resolution.mdc`
- `.rules/P0-core-safety/ai-ethical-boundaries.mdc`

**修复内容**:

```yaml
# 在 rule-conflict-resolution.mdc 中修改

优先级层次 (修复后):
  Level 0 - 不可违反底线 (优先级: ∞):
    - 法律法规禁止
    - 平台政策禁止
    - 不可逆严重危害
    - 来源: ai-ethical-boundaries.mdc
  
  Level 1 - 核心安全规则 (优先级: 1100-1200):
    - 文件生成安全检查 (1200)
    - 权限控制验证
    - 敏感信息保护
    - 来源: file-generation-safety-rules.mdc
  
  Level 2 - 用户指令 (优先级: 动态):
    - 在 Level 0-1 边界内: 最高优先
    - 超出安全边界: 需确认或拒绝
    - 明确指令优先于默认规则
  
  Level 3 - 功能规则 (优先级: 300-999):
    - 智能系统规则
    - 开发工作流规则
    - 工具策略规则

执行逻辑:
  if 用户指令 触犯 Level 0:
    → 拒绝 + 说明原因 + 提供安全替代方案
  
  elif 用户指令 触犯 Level 1:
    → 警告 + 风险说明 + 请求确认
    → 用户确认后可执行（记录审计日志）
  
  else:
    → 用户指令优先执行
```

**修改位置**: `line 16-68`

---

### 2. Memory 系统权限边界明确化 🔒

**问题**: Recorder vs Memory 使用规则模糊

**影响文件**:
- `.rules/P2-intelligent-system/context-recorder-system.mdc`
- `.rules/P2-intelligent-system/memory-system-integration.mdc`

**修复内容**:

```yaml
# 在 memory-system-integration.mdc 中新增

Memory 使用授权机制:
  
  自动使用 (无需授权):
    - 仅读取已有 Memory 数据
    - 搜索公开知识节点
    - 查询非敏感信息
  
  需要授权 (必须询问用户):
    - 创建新的 Memory 实体
    - 写入项目相关信息
    - 记录决策和方案
    - 建立跨项目关联
  
  禁止使用 (直接拒绝):
    - 存储敏感信息 (密码、密钥、token)
    - 记录商业机密
    - 存储个人隐私数据
    - 未经脱敏的真实数据

授权话术模板:
  "我建议将以下信息记录到 Memory 系统以便长期保存和跨会话检索：
   
   📝 待记录内容:
   - 实体: [实体名称]
   - 类型: [实体类型]
   - 关系: [关联关系]
   
   ⚠️ Memory 说明:
   - 数据将持久化存储
   - 可跨会话和项目检索
   - 您随时可以删除
   
   是否授权记录? (y/n)"

Recorder vs Memory 决策树:
  本地项目信息 → Recorder (project.context.md)
  需要跨会话搜索 → 询问后使用 Memory
  需要语义检索 → 询问后使用 Memory
  临时信息 → 仅 Recorder
  敏感信息 → 仅 Recorder (不进 Memory)
```

**新增位置**: 文件末尾新增专门章节

---

## 🟡 P1 级别修复（本周完成）

### 3. MCP 检测缓存机制增强 ⚡

**问题**: 缓存时间过长，无法感知配置变更

**影响文件**:
- `.rules/P1-core-identity/mcp-zero-config-detection.mdc`

**修复内容**:

```yaml
# 在 mcp-zero-config-detection.mdc 中修改

缓存策略增强 (v2.0):
  
  多级缓存机制:
    L1 缓存 (5分钟):
      - 用户正在配置 MCP
      - 检测到配置文件变更
      - 用户明确要求刷新
    
    L2 缓存 (30分钟):
      - 正常使用场景
      - 配置稳定期
      - 默认缓存级别
    
    L3 缓存 (2小时):
      - 配置长期未变更
      - 系统稳定运行
      - 性能优化场景
  
  智能失效机制:
    文件监控:
      - 监控配置文件 mtime
      - 计算文件内容哈希
      - 变更时立即失效缓存
    
    监控路径:
      - %USERPROFILE%\.claude\mcp_settings.json
      - %USERPROFILE%\AppData\Roaming\Cursor\User\globalStorage\cursor.mcp\mcp_settings.json
      - %USERPROFILE%\AppData\Roaming\Trae\User\mcp.json
      - [其他配置路径...]
    
    触发条件:
      - mtime 变化 → 立即失效
      - hash 变化 → 立即失效
      - 用户"重新检测" → 强制失效
      - 超过 TTL → 自然失效
  
  缓存元数据:
    {
      "version": "2.0",
      "timestamp": "2025-10-18T10:30:00Z",
      "ttl": 1800,  # 30分钟
      "cache_level": "L2",
      "file_hashes": {
        "claude": "abc123...",
        "cursor": "def456..."
      },
      "detection_source": "mcp-unified-management",
      "result_summary": {
        "total_tools": 5,
        "platforms": ["Cursor", "Claude"],
        "missing_tools": ["server-github"]
      }
    }
  
  实现伪代码:
    function should_use_cache():
      cache = load_cache()
      
      if not cache or cache.expired():
        return False
      
      if user_requested_refresh():
        return False
      
      for config_file, old_hash in cache.file_hashes:
        if not file_exists(config_file):
          continue
        
        current_hash = calculate_hash(config_file)
        if current_hash != old_hash:
          invalidate_cache()
          return False
      
      return True
```

**修改位置**: `line 29-47`

---

### 4. 规则文件版本管理系统 📋

**问题**: 规则文件缺少版本追踪

**影响文件**: 所有 `.mdc` 规则文件

**修复内容**:

```yaml
# 在每个规则文件的 frontmatter 中添加

---
type: "always_apply"
description: "规则描述"
globs: ["**/*"]
priority: 1200
alwaysApply: true

# 新增版本管理字段
version: "2.1.0"
last_updated: "2025-10-18"
author: "system"
status: "stable"  # draft | stable | deprecated
compatibility: "rule-system >= 2.0"

changelog:
  - version: "2.1.0"
    date: "2025-10-18"
    changes:
      - "修复优先级冲突漏洞"
      - "增强安全边界定义"
  
  - version: "2.0.0"
    date: "2025-01-17"
    changes:
      - "重构规则架构"
      - "新增智能推荐系统"

dependencies:
  - "ai-ethical-boundaries.mdc >= 2.0"
  - "rule-conflict-resolution.mdc >= 2.1"
---
```

**批量修改脚本**:

```powershell
# scripts/add-version-to-rules.ps1

$rulesDir = ".rules"
$version = "2.1.0"
$date = Get-Date -Format "yyyy-MM-dd"

Get-ChildItem -Path $rulesDir -Filter "*.mdc" -Recurse | ForEach-Object {
    $content = Get-Content $_.FullName -Raw
    
    if ($content -match "---\n(.*?)\n---") {
        $frontmatter = $Matches[1]
        
        if ($frontmatter -notmatch "version:") {
            $newFrontmatter = $frontmatter + "`nversion: `"$version`"`n" +
                              "last_updated: `"$date`"`n" +
                              "status: `"stable`""
            
            $newContent = $content -replace "---\n(.*?)\n---", "---`n$newFrontmatter`n---"
            Set-Content -Path $_.FullName -Value $newContent -NoNewline
            
            Write-Host "✅ 已更新: $($_.Name)"
        }
    }
}
```

---

### 5. 模板变量命名统一 🔧

**问题**: 模板使用 `${}` 和 `{{}}` 混用

**影响文件**:
- `templates/project-init-template.md`
- `templates/archive-init-template.md`

**修复方案**: 统一使用 `${VARIABLE_NAME}` 格式

```bash
# 批量替换脚本
cd templates/
sed -i 's/{{PROJECT_NAME}}/${PROJECT_NAME}/g' *.md
sed -i 's/{{TIMESTAMP}}/${TIMESTAMP}/g' *.md
sed -i 's/{{USER}}/${USER}/g' *.md
# ... 其他变量
```

---

## 🟢 P2 级别修复（本月完成）

### 6. 错误恢复机制 🔄

**新增文件**: `.rules/P2-intelligent-system/error-recovery-system.mdc`

```yaml
错误恢复机制:
  
  系统激活中断恢复:
    检测方法:
      - 检查 project.context.md 存在性
      - 验证文件完整性（必需区块）
      - 检查元数据一致性
    
    恢复策略:
      - 完整性 100%: 跳过激活
      - 完整性 50-99%: 补全缺失部分
      - 完整性 <50%: 重新激活
      - 完整性 0%: 全新激活
  
  文件操作失败恢复:
    备份机制:
      - 修改前自动备份
      - 保留最近 3 个版本
      - 失败时自动回滚
    
    恢复命令:
      - /恢复上一版本
      - /查看备份历史
      - /手动回滚
  
  MCP 工具故障恢复:
    故障检测:
      - 工具调用超时
      - 工具返回错误
      - 工具不可用
    
    恢复策略:
      - 自动切换备用工具
      - 降级到基础工具
      - 手动模式提示
```

---

### 7. 审计日志系统 📊

**新增文件**: `.rules/P2-intelligent-system/audit-logging-system.mdc`

```yaml
审计日志系统:
  
  日志级别:
    CRITICAL: 安全违规、系统错误
    WARNING: 风险操作、性能警告
    INFO: 正常操作、状态变更
    DEBUG: 详细调试信息
  
  记录内容:
    操作日志:
      - 时间戳
      - 操作类型
      - 操作者（用户/AI）
      - 影响范围
      - 结果状态
    
    安全事件:
      - 权限检查
      - 敏感操作
      - 异常行为
      - 拒绝原因
  
  日志文件:
    - .logs/agent-audit.log (操作日志)
    - .logs/security-events.log (安全日志)
    - .logs/performance.log (性能日志)
  
  日志轮转:
    - 每日轮转
    - 保留 30 天
    - 压缩归档
```

---

### 8. 规则一致性验证脚本 ✅

**新增文件**: `scripts/validate-rules-v2.ps1`

```powershell
# 规则一致性验证脚本 v2.0

function Test-RuleConsistency {
    $issues = @()
    
    # 1. 检查优先级冲突
    Write-Host "🔍 检查优先级冲突..."
    $rules = Get-ChildItem -Path ".rules" -Filter "*.mdc" -Recurse
    $priorities = @{}
    
    foreach ($rule in $rules) {
        $content = Get-Content $rule.FullName -Raw
        if ($content -match "priority:\s*(\d+)") {
            $priority = [int]$Matches[1]
            $name = $rule.Name
            
            if ($priorities.ContainsKey($priority)) {
                $issues += "⚠️ 优先级冲突: $name 和 $($priorities[$priority]) 都使用 $priority"
            }
            $priorities[$priority] = $name
        }
    }
    
    # 2. 检查版本字段
    Write-Host "🔍 检查版本字段..."
    foreach ($rule in $rules) {
        $content = Get-Content $rule.FullName -Raw
        if ($content -notmatch "version:") {
            $issues += "❌ 缺少版本字段: $($rule.Name)"
        }
    }
    
    # 3. 检查引用一致性
    Write-Host "🔍 检查规则引用..."
    $allRules = $rules | ForEach-Object { $_.BaseName }
    
    foreach ($rule in $rules) {
        $content = Get-Content $rule.FullName -Raw
        $references = [regex]::Matches($content, "(\w+\.mdc)")
        
        foreach ($ref in $references) {
            $refName = $ref.Groups[1].Value -replace "\.mdc$", ""
            if ($refName -notin $allRules) {
                $issues += "⚠️ 无效引用: $($rule.Name) 引用了不存在的 $($ref.Groups[1].Value)"
            }
        }
    }
    
    # 4. 检查优先级范围
    Write-Host "🔍 检查优先级范围..."
    $priorityRanges = @{
        "P0" = @(1100, 1200)
        "P1" = @(1000, 1099)
        "P2" = @(900, 999)
        "P3" = @(800, 899)
        "P4" = @(700, 799)
        "P5" = @(600, 699)
        "P6" = @(500, 599)
        "P7" = @(300, 499)
    }
    
    foreach ($rule in $rules) {
        $content = Get-Content $rule.FullName -Raw
        $path = $rule.DirectoryName
        
        if ($content -match "priority:\s*(\d+)") {
            $priority = [int]$Matches[1]
            $pLevel = ($path -split "[\\/]")[-1]
            
            if ($priorityRanges.ContainsKey($pLevel)) {
                $range = $priorityRanges[$pLevel]
                if ($priority -lt $range[0] -or $priority -gt $range[1]) {
                    $issues += "⚠️ 优先级超出范围: $($rule.Name) ($priority) 不在 $pLevel 范围 $($range[0])-$($range[1])"
                }
            }
        }
    }
    
    # 输出结果
    Write-Host "`n" + ("="*60)
    if ($issues.Count -eq 0) {
        Write-Host "✅ 规则一致性检查通过！" -ForegroundColor Green
    } else {
        Write-Host "❌ 发现 $($issues.Count) 个问题：`n" -ForegroundColor Red
        $issues | ForEach-Object { Write-Host $_ }
    }
    Write-Host ("="*60)
    
    return $issues.Count -eq 0
}

# 执行验证
Test-RuleConsistency
```

---

## 📋 实施计划

### 第 1 天 (2-3小时)
- [ ] 修复优先级冲突 (P0-1)
- [ ] 明确 Memory 权限边界 (P0-2)
- [ ] 测试安全机制

### 第 2-3 天 (3-4小时)
- [ ] 增强 MCP 缓存机制 (P1-3)
- [ ] 添加规则版本管理 (P1-4)
- [ ] 统一模板变量 (P1-5)

### 第 4-7 天 (4-5小时)
- [ ] 实现错误恢复机制 (P2-6)
- [ ] 部署审计日志系统 (P2-7)
- [ ] 开发验证脚本 (P2-8)
- [ ] 全面测试

---

## 🧪 验证清单

```yaml
测试场景:
  安全测试:
    - [ ] 用户请求绕过安全检查 → 应拒绝
    - [ ] 用户明确确认风险操作 → 应执行并记录
    - [ ] 敏感信息泄露检测 → 应自动脱敏
  
  权限测试:
    - [ ] AI 尝试使用 Memory → 应请求授权
    - [ ] AI 记录到 Recorder → 应无需授权
    - [ ] 敏感信息写入 Memory → 应拒绝
  
  缓存测试:
    - [ ] 配置文件变更 → 缓存应失效
    - [ ] 正常场景 → 应使用缓存
    - [ ] 用户强制刷新 → 应重新检测
  
  恢复测试:
    - [ ] 系统激活中断 → 应能恢复
    - [ ] 文件操作失败 → 应能回滚
    - [ ] 工具调用失败 → 应能切换
```

---

## 📊 修复后预期效果

```yaml
改进指标:
  安全性: 85 → 95 分 (+10)
  一致性: 78 → 92 分 (+14)
  可维护性: 82 → 90 分 (+8)
  可靠性: 75 → 88 分 (+13)
  
  总分: 82 → 91 分 (+9)

具体提升:
  ✅ 消除安全漏洞
  ✅ 明确权限边界
  ✅ 提升响应准确性
  ✅ 增强系统稳定性
  ✅ 改善可维护性
```

---

## 🔗 相关文件

- 规则目录: `.rules/`
- 模板目录: `templates/`
- 脚本目录: `scripts/`
- 日志目录: `.logs/` (新增)
- 项目记忆: `project-memory/`

---

**修复方案版本**: v1.0  
**生成时间**: 2025-10-18  
**下次审查**: 修复完成后

